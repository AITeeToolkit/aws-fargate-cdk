name: Infrastructure Build & Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment (dev/prod)"
        required: true
        type: string
      image_tag:
        description: "Default docker image tag to deploy"
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true
      AWS_CODEBUILD_ACCESS_KEY_ID:
        required: true
      AWS_CODEBUILD_SECRET_ACCESS_KEY:
        required: true

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_CODEBUILD_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_CODEBUILD_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: CDK Bootstrap
        run: cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/us-east-1

      - name: Set image tags
        run: |
          echo "LISTENER_IMAGE_TAG=${{ github.event.inputs.listener_tag || 'skip' }}" >> $GITHUB_ENV
          echo "API_IMAGE_TAG=${{ github.event.inputs.api_tag || 'skip' }}" >> $GITHUB_ENV
          echo "WEB_IMAGE_TAG=${{ github.event.inputs.web_tag || 'skip' }}" >> $GITHUB_ENV

      - name: CDK Deploy
        run: |
          echo "ðŸš€ Deploying infra"
          echo "  API=${API_IMAGE_TAG}"
          echo "  WEB=${WEB_IMAGE_TAG}"
          echo "  LISTENER=${LISTENER_IMAGE_TAG}"

          DEPLOY_ENV="--context env=${{ inputs.environment }}"

          if [ "$API_IMAGE_TAG" != "skip" ]; then
            DEPLOY_ENV="$DEPLOY_ENV --context apiTag=$API_IMAGE_TAG"
          fi
          if [ "$WEB_IMAGE_TAG" != "skip" ]; then
            DEPLOY_ENV="$DEPLOY_ENV --context webTag=$WEB_IMAGE_TAG"
          fi
          if [ "$LISTENER_IMAGE_TAG" != "skip" ]; then
            DEPLOY_ENV="$DEPLOY_ENV --context listenerTag=$LISTENER_IMAGE_TAG"
          fi

          cdk deploy --require-approval never --all $DEPLOY_ENV