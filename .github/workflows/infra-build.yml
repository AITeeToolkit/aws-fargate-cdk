name: Infrastructure Build & Deploy

on:
  workflow_call:
  repository_dispatch:
    types: [deploy-infrastructure]
    inputs:
      environment:
        description: "Deployment environment (dev/prod)"
        required: true
        type: string
      image_tag:
        description: "Image tag"
        required: true
        type: string
      listener_tag:
        description: "Listener image tag"
        required: false
        type: string
      api_tag:
        description: "API image tag"
        required: false
        type: string
      web_tag:
        description: "Web image tag"
        required: false
        type: string
    secrets:
      GH_TOKEN:
        required: true
      AWS_CODEBUILD_ACCESS_KEY_ID:
        required: true
      AWS_CODEBUILD_SECRET_ACCESS_KEY:
        required: true
      AWS_ACCOUNT_ID:
        required: true

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_CODEBUILD_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_CODEBUILD_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install CDK
        run: npm install -g aws-cdk

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: CDK Bootstrap
        run: cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/us-east-1

      - name: Set Image Tags
        run: |
          # Handle both workflow_call inputs and repository_dispatch client_payload
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "LISTENER_IMAGE_TAG=skip" >> $GITHUB_ENV
            echo "API_IMAGE_TAG=${{ github.event.client_payload.api_tag || 'skip' }}" >> $GITHUB_ENV
            echo "WEB_IMAGE_TAG=${{ github.event.client_payload.web_tag || 'skip' }}" >> $GITHUB_ENV
            echo "ENVIRONMENT=${{ github.event.client_payload.environment || 'dev' }}" >> $GITHUB_ENV
          else
            echo "LISTENER_IMAGE_TAG=${{ inputs.listener_tag || 'skip' }}" >> $GITHUB_ENV
            echo "API_IMAGE_TAG=${{ inputs.api_tag || 'skip' }}" >> $GITHUB_ENV
            echo "WEB_IMAGE_TAG=${{ inputs.web_tag || 'skip' }}" >> $GITHUB_ENV
            echo "ENVIRONMENT=${{ inputs.environment || 'dev' }}" >> $GITHUB_ENV
          fi

      - name: CDK Deploy
        run: |
          echo "ðŸš€ Deploying with image tags:"
          echo "  Listener: $LISTENER_IMAGE_TAG"
          echo "  API:      $API_IMAGE_TAG"
          echo "  Web:      $WEB_IMAGE_TAG"
          
          CONTEXT="--context env=$ENVIRONMENT"
          CONTEXT="$CONTEXT --context listenerTag=$LISTENER_IMAGE_TAG"
          CONTEXT="$CONTEXT --context apiTag=$API_IMAGE_TAG"
          CONTEXT="$CONTEXT --context webTag=$WEB_IMAGE_TAG"

          cdk deploy --require-approval never --all $CONTEXT