name: Test Suite

concurrency:
  group: test-suite-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches: [main, develop]
  # Removed push trigger to prevent duplicate runs with semantic-release
  # push:
  #   branches: [main, develop]
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        type: string
        default: 'dev'
    outputs:
      test_results:
        description: 'Test results summary'
        value: ${{ jobs.test-summary.outputs.results }}

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: ${{ inputs.environment || 'dev' }}

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('tests/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
          pip install -r requirements.txt
          
      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=stacks --cov=apps \
            --junitxml=junit/unit-test-results.xml \
            --html=junit/unit-test-results.html --self-contained-html \
            --cov-report=xml \
            --cov-report=html:htmlcov
          
      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          coverage = float(root.attrib['line-rate']) * 100
          print(f'{coverage:.1f}')
          ")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: junit/unit-test-results.xml
          
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

  lint-and-security:
    name: Lint & Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort bandit safety
          # Verify installations
          black --version
          isort --version
          flake8 --version
          bandit --version
          safety --version
          
      - name: Run Black formatter check
        run: black --check --diff .
        
      - name: Run isort import sorting check
        run: isort --check-only --diff .
        
      - name: Run flake8 linting
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
      - name: Run Bandit security scan
        run: |
          echo "Running Bandit security scan..."
          if bandit -r . -f json -o bandit-report.json; then
            echo "Bandit scan completed successfully"
          else
            echo "Bandit scan failed or found no issues, creating empty report"
            echo '{"results": [], "errors": [], "metrics": {}}' > bandit-report.json
          fi
          ls -la bandit-report.json
        continue-on-error: true
        
      - name: Run Safety dependency scan
        run: |
          echo "Running Safety dependency scan..."
          if safety check --json --output safety-report.json; then
            echo "Safety scan completed successfully"
          else
            echo "Safety scan failed or found no issues, creating empty report"
            echo '{"vulnerabilities": [], "report_meta": {}}' > safety-report.json
          fi
          ls -la safety-report.json
        continue-on-error: true
        
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: true  # Enabled - all environments are now deployed
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
          pip install -r requirements.txt
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_CODEBUILD_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_CODEBUILD_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Run integration tests
        run: |
          pytest tests/integration/ -v -m "not slow" \
            --junitxml=junit/integration-test-results.xml \
            --tb=short
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: junit/integration-test-results.xml

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: true  # Enabled - staging environment is deployed
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
          pip install -r requirements.txt
          pip install locust
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_CODEBUILD_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_CODEBUILD_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Get service endpoints
        id: endpoints
        run: |
          # Get ALB DNS from CloudFormation outputs
          ENV_NAME="${{ env.ENVIRONMENT }}"
          
          # Try to get MultiAlbStack outputs (Web service is on ALB)
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name "MultiAlbStack-${ENV_NAME}" \
            --query 'Stacks[0].Outputs[?OutputKey==`AlbDnsName`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$ALB_DNS" ]; then
            echo "WEB_ENDPOINT=https://${ALB_DNS}" >> $GITHUB_ENV
            echo "âœ… Web endpoint configured: https://${ALB_DNS}"
          else
            echo "âš ï¸  Could not find ALB DNS, performance tests may skip"
          fi
      
      - name: Run performance tests
        id: perf_tests
        run: |
          pytest tests/integration/test_performance.py -v -m "performance" \
            --junitxml=junit/performance-test-results.xml \
            --tb=short \
            -v 2>&1 | tee perf_output.txt
          
          # Check if all tests were skipped
          SKIPPED=$(grep -c "SKIPPED" perf_output.txt || echo "0")
          PASSED=$(grep -c "PASSED" perf_output.txt || echo "0")
          
          if [ "$PASSED" -eq 0 ] && [ "$SKIPPED" -gt 0 ]; then
            echo "âš ï¸  All performance tests were skipped - no tests actually ran!"
            echo "This usually means endpoints are not configured."
            exit 1
          fi
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          
      - name: Upload performance test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: junit/performance-test-results.xml

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, lint-and-security, integration-tests, performance-tests]
    if: always()
    outputs:
      results: ${{ steps.summary.outputs.results }}
    steps:
      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        
      - name: Generate test summary
        id: summary
        run: |
          echo "# ðŸ§ª Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Unit Tests
          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "âœ… **Unit Tests**: Passed (Coverage: ${{ needs.unit-tests.outputs.coverage }}%)" >> $GITHUB_STEP_SUMMARY
            UNIT_STATUS="âœ… PASS"
          else
            echo "âŒ **Unit Tests**: Failed" >> $GITHUB_STEP_SUMMARY
            UNIT_STATUS="âŒ FAIL"
          fi
          
          # Lint & Security
          if [ "${{ needs.lint-and-security.result }}" = "success" ]; then
            echo "âœ… **Lint & Security**: Passed" >> $GITHUB_STEP_SUMMARY
            LINT_STATUS="âœ… PASS"
          else
            echo "âŒ **Lint & Security**: Failed" >> $GITHUB_STEP_SUMMARY
            LINT_STATUS="âŒ FAIL"
          fi
          
          # Integration Tests
          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "âœ… **Integration Tests**: Passed" >> $GITHUB_STEP_SUMMARY
            INTEGRATION_STATUS="âœ… PASS"
          elif [ "${{ needs.integration-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ **Integration Tests**: Skipped" >> $GITHUB_STEP_SUMMARY
            INTEGRATION_STATUS="â­ï¸ SKIP"
          else
            echo "âŒ **Integration Tests**: Failed" >> $GITHUB_STEP_SUMMARY
            INTEGRATION_STATUS="âŒ FAIL"
          fi
          
          # Performance Tests
          if [ "${{ needs.performance-tests.result }}" = "success" ]; then
            echo "âœ… **Performance Tests**: Passed" >> $GITHUB_STEP_SUMMARY
            PERFORMANCE_STATUS="âœ… PASS"
          elif [ "${{ needs.performance-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ **Performance Tests**: Skipped" >> $GITHUB_STEP_SUMMARY
            PERFORMANCE_STATUS="â­ï¸ SKIP"
          else
            echo "âŒ **Performance Tests**: Failed" >> $GITHUB_STEP_SUMMARY
            PERFORMANCE_STATUS="âŒ FAIL"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $UNIT_STATUS | ${{ needs.unit-tests.outputs.coverage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Security | $LINT_STATUS | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | $INTEGRATION_STATUS | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | $PERFORMANCE_STATUS | - |" >> $GITHUB_STEP_SUMMARY
          
          # Set overall result (all tests must pass)
          if [[ "${{ needs.unit-tests.result }}" == "success" && 
                "${{ needs.lint-and-security.result }}" == "success" && 
                ("${{ needs.integration-tests.result }}" == "success" || "${{ needs.integration-tests.result }}" == "skipped") && 
                ("${{ needs.performance-tests.result }}" == "success" || "${{ needs.performance-tests.result }}" == "skipped") ]]; then
            echo "results=success" >> $GITHUB_OUTPUT
          else
            echo "results=failure" >> $GITHUB_OUTPUT
          fi
